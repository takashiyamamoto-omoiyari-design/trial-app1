# CRUD操作別テスト手順書

## 📋 **概要**
結合テスト仕様書のCRUD操作別テストマトリックスを実際に実行するための詳細手順書です。

---

## 🔧 **Create (作成) 操作のテスト**

### **C-01: 正常系 - 自分のインデックスへの登録**

#### **テスト手順**
1. **ログイン**
   ```
   ユーザー: haga
   パスワード: PjJae4C4XDfA
   ```

2. **ファイルアップロード**
   - データ構造化ページにアクセス
   - 「ファイルを選択」ボタンをクリック
   - `haga_test_document.pdf`を選択
   - 「アップロード開始」ボタンをクリック

3. **結果確認**
   - ✅ **成功の場合**: 
     - 「アップロード完了」メッセージが表示
     - workIdが生成される
     - 処理状況が「完了」になる
   - ❌ **失敗の場合**: エラーメッセージを記録

4. **Azure Search確認**
   - Azure portalにアクセス
   - `haga`インデックスを確認
   - 新しいドキュメントが追加されているか確認

#### **期待結果**
- ✅ `hagaインデックス`に正常に登録される
- ✅ `haga-sentenceインデックス`にも登録される
- ✅ 他のインデックス（admin、oec、etc）には登録されない

---

### **C-02: 異常系 - 他人のインデックスへの登録試行**

#### **テスト手順**
1. **事前準備**
   - 開発者ツールまたはプロキシツール（Burp Suite等）を起動
   - ネットワークトラフィックを監視

2. **ログイン**
   ```
   ユーザー: haga
   パスワード: PjJae4C4XDfA
   ```

3. **不正操作試行**
   - ファイルアップロード画面でファイルを選択
   - 開発者ツールでリクエストを傍受
   - リクエストボディの`username`を`admin`に変更
   - または、URLパラメータに`?forceIndex=admin`を追加
   - 変更したリクエストを送信

4. **結果確認**
   - ✅ **正常な場合**: 
     - 「権限エラー」または「アクセス拒否」メッセージ
     - HTTP 403 Forbidden
     - hagaインデックスにのみ登録される
   - ❌ **異常な場合**: adminインデックスに登録されてしまう（セキュリティホール）

#### **期待結果**
- ✅ リクエスト改ざんが検出され、エラーになる
- ✅ 他ユーザーのインデックスに登録されない
- ✅ 適切なエラーメッセージが表示される

---

## 📖 **Read (読み取り) 操作のテスト**

### **R-01: 正常系 - 自分のデータ表示**

#### **テスト手順**
1. **事前準備**
   - hagaユーザーでデータを1件以上アップロード済み

2. **ログイン**
   ```
   ユーザー: haga
   パスワード: PjJae4C4XDfA
   ```

3. **文書一覧表示**
   - データ構造化ページにアクセス
   - 「文書一覧」または「workId一覧」を確認
   - 自分がアップロードした文書が表示されるか確認

4. **検索機能**
   - 検索ボックスに自分の文書に含まれるキーワードを入力
   - 検索を実行
   - 結果が表示されるか確認

5. **チャット機能**
   - チャット画面にアクセス
   - 自分の文書に関する質問を入力
   - 「この文書について教えてください」
   - 回答が返されるか確認

#### **期待結果**
- ✅ 自分の文書が文書一覧に表示される
- ✅ 自分の文書が検索結果に含まれる
- ✅ 自分の文書に基づいた回答が返される

---

### **R-02: 異常系 - 他人のデータ非表示**

#### **テスト手順**
1. **事前準備**
   - adminユーザーでデータを1件以上アップロード済み
   - そのデータに含まれる特徴的なキーワードを把握

2. **ログイン**
   ```
   ユーザー: haga
   パスワード: PjJae4C4XDfA
   ```

3. **文書一覧確認**
   - 文書一覧を確認
   - adminユーザーの文書が表示されないことを確認

4. **検索テスト**
   - adminの文書に含まれるキーワードで検索
   - 例：「管理者」「admin」「機密」など
   - 検索結果にadminの文書が含まれないことを確認

5. **チャット確認**
   - adminの文書に関する質問をする
   - 例：「管理者の機密文書について教えてください」
   - 「該当する文書が見つかりません」的な回答が返されることを確認

6. **URLハッキング試行**
   - URL直接操作を試行
   - 例：`/document/admin_work_id`
   - 403エラーまたはアクセス拒否されることを確認

#### **期待結果**
- ✅ 他ユーザーの文書が一覧に表示されない
- ✅ 他ユーザーの文書が検索結果に含まれない
- ✅ 他ユーザーの文書に関する質問で適切にアクセス拒否される
- ✅ 直接URL操作でもアクセス拒否される

---

## 🔄 **Update (更新) 操作のテスト**

### **U-01: 正常系 - 自分のデータ更新**

#### **テスト手順**
1. **事前準備**
   - hagaユーザーでデータを1件アップロード済み
   - そのworkIdを控えておく

2. **ログイン**
   ```
   ユーザー: haga
   パスワード: PjJae4C4XDfA
   ```

3. **同じファイルの再アップロード**
   - 元のファイルを少し修正（テキストを追加）
   - 同じファイル名で再アップロード
   - または、処理状況画面で「再処理」ボタンをクリック

4. **結果確認**
   - 更新完了メッセージが表示されるか確認
   - Azure Searchで更新日時が変更されているか確認
   - チャットで新しい内容について質問して回答が更新されているか確認

#### **期待結果**
- ✅ 自分のデータが正常に更新される
- ✅ 新しい内容が検索・チャットに反映される

---

### **U-02: 異常系 - 他人のデータ更新試行**

#### **テスト手順**
1. **事前準備**
   - adminユーザーでデータを1件アップロード済み
   - そのworkIdを把握

2. **ログイン**
   ```
   ユーザー: haga
   パスワード: PjJae4C4XDfA
   ```

3. **不正更新試行**
   - ファイルアップロード画面でファイルを選択
   - 開発者ツールでリクエストを傍受
   - workIdをadminユーザーのものに変更
   - リクエストを送信

4. **結果確認**
   - ✅ **正常な場合**: 
     - 権限エラーが発生
     - adminのデータは更新されない
   - ❌ **異常な場合**: adminのデータが更新されてしまう

#### **期待結果**
- ✅ 他ユーザーのデータ更新が拒否される
- ✅ 適切なエラーメッセージが表示される

---

## 🗑️ **Delete (削除) 操作のテスト**

### **D-01: 正常系 - 自分のデータ削除**

#### **テスト手順**
1. **事前準備**
   - hagaユーザーでテスト用データを1件アップロード

2. **ログイン**
   ```
   ユーザー: haga
   パスワード: PjJae4C4XDfA
   ```

3. **削除操作**
   - 文書一覧から削除対象を選択
   - 「削除」ボタンをクリック
   - 確認ダイアログで「OK」をクリック

4. **結果確認**
   - 文書一覧から削除されているか確認
   - Azure Searchからも削除されているか確認
   - チャットで該当文書について質問して「見つかりません」になるか確認

#### **期待結果**
- ✅ 自分のデータが正常に削除される
- ✅ 検索・チャットからも削除される

---

### **D-02: 異常系 - 他人のデータ削除試行**

#### **テスト手順**
1. **事前準備**
   - adminユーザーでデータを1件アップロード済み
   - そのworkIdを把握

2. **ログイン**
   ```
   ユーザー: haga
   パスワード: PjJae4C4XDfA
   ```

3. **不正削除試行**
   - 開発者ツールでDELETEリクエストを作成
   - URL: `/api/document/admin_work_id`
   - リクエストを送信

4. **結果確認**
   - ✅ **正常な場合**: 
     - 403 Forbidden エラー
     - adminのデータは削除されない
   - ❌ **異常な場合**: adminのデータが削除されてしまう

#### **期待結果**
- ✅ 他ユーザーのデータ削除が拒否される
- ✅ 適切なエラーメッセージが表示される

---

## 📊 **実行チェックリスト**

### **Create操作**
- [ ] C-01: 自分のインデックスへの正常登録
- [ ] C-02: 他人のインデックスへの登録拒否
- [ ] Azure Searchでの分離確認

### **Read操作**
- [ ] R-01: 自分のデータ正常表示
- [ ] R-02: 他人のデータ非表示
- [ ] 文書一覧、検索、チャット全てで確認

### **Update操作**
- [ ] U-01: 自分のデータ正常更新
- [ ] U-02: 他人のデータ更新拒否

### **Delete操作**
- [ ] D-01: 自分のデータ正常削除
- [ ] D-02: 他人のデータ削除拒否

---

## 🔍 **確認ポイント**

### **1. 画面での確認**
- エラーメッセージの内容
- 操作結果の表示
- ログイン状態の継続

### **2. バックエンドでの確認**
- Azure Searchの実際のデータ
- ログファイルの内容
- HTTPレスポンスコード

### **3. セキュリティ確認**
- 権限チェックの動作
- 不正操作の検出
- エラーハンドリング

---

## 🚨 **テスト実行上の注意点**

### **1. データ準備**
- 各テストケースで使用するテストデータを事前に準備
- 本番データを使用しないよう注意

### **2. 環境確認**
- テスト環境であることを確認
- Azure Searchの接続先を確認

### **3. 不正操作の実行**
- 開発者ツールやプロキシツールの使用方法を習得
- 不正操作は必ずテスト環境で実行

### **4. 結果の記録**
- 各テストケースの実行結果を詳細に記録
- スクリーンショットを取得
- ログファイルを保存

---

## 📝 **テスト結果記録表**

| テストケース | 実行日 | 実行者 | 結果 | 備考 |
|--------------|--------|--------|------|------|
| C-01 | | | ✅/❌ | |
| C-02 | | | ✅/❌ | |
| R-01 | | | ✅/❌ | |
| R-02 | | | ✅/❌ | |
| U-01 | | | ✅/❌ | |
| U-02 | | | ✅/❌ | |
| D-01 | | | ✅/❌ | |
| D-02 | | | ✅/❌ | |

この手順書に従って実行することで、CRUD操作別テストマトリックスを確実に検証できます。 