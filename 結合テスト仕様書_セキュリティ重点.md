# セキュリティ重点 結合テスト仕様書

## 📋 **テスト概要**

### **目的**
- ユーザー間のデータ分離が適切に実装されているかを検証
- 権限のないユーザーが他ユーザーのデータにアクセスできないことを確認
- セキュリティ境界が正しく機能していることを保証

### **テスト観点**
1. **データ分離**: Aユーザーのデータが他ユーザーのインデックスに混入しない
2. **表示制御**: 権限のないデータが画面に表示されない
3. **検索制御**: 権限のないデータが検索結果に含まれない
4. **CRUD権限**: 各操作で適切な権限チェックが動作する

---

## 🧪 **テスト環境設定**

### **テストユーザー**
| ユーザー | パスワード | 許可インデックス | 役割 |
|----------|------------|------------------|------|
| admin | dpJpMVGuPtQ9 | admin, admin-sentence | 管理者 |
| oec | 4JkVNwuWJgMH | oec, oec-sentence | 一般ユーザー |
| haga | PjJae4C4XDfA | haga, haga-sentence | 一般ユーザー |
| nakajima | MgD3bugYyDrn | nakajima, nakajima-sentence | 一般ユーザー |

### **テストデータ**
| ファイル名 | 内容 | 用途 |
|------------|------|------|
| admin_doc.pdf | 管理者用機密文書 | admin専用データ |
| oec_doc.pdf | OEC部門資料 | oec専用データ |
| haga_doc.pdf | 営業部資料 | haga専用データ |
| nakajima_doc.pdf | 開発部資料 | nakajima専用データ |

---

## 🔒 **セキュリティテストケース**

### **TC-S01: 正常系 - 自己データアクセス**

| 項目 | 内容 |
|------|------|
| **目的** | 各ユーザーが自分のデータに正常にアクセスできることを確認 |
| **前提条件** | - 各ユーザーの専用データが存在しない状態 |

#### **テスト手順**
1. **ログイン** → oecユーザーでログイン
2. **ファイルアップロード** → oec_doc.pdfをアップロード
3. **アップロード状況確認** → 処理状況が「完了」になることを確認
4. **表示** → 文書一覧にoec_doc.pdfが表示されることを確認
5. **チャット** → アップロードした文書について質問し、適切に回答されることを確認
6. **ログアウト** → 正常にログアウトできることを確認

#### **期待結果**
- ✅ 全ての操作が正常に完了する
- ✅ oecインデックスにのみデータが登録される
- ✅ 文書内容が適切に表示・検索される

---

### **TC-S02: 異常系 - 他ユーザーデータ非表示**

| 項目 | 内容 |
|------|------|
| **目的** | 他ユーザーのデータが表示されないことを確認 |
| **前提条件** | - TC-S01完了後（oecユーザーのデータが存在） |

#### **テスト手順**
1. **ログイン** → hagaユーザーでログイン
2. **表示** → 文書一覧を確認
3. **検索** → 「OEC」で検索を実行
4. **チャット** → oec_doc.pdfに関する質問を実行
5. **ログアウト** → ログアウト

#### **期待結果**
- ✅ 文書一覧にoec_doc.pdfが表示されない
- ✅ 「OEC」検索結果にoecユーザーのデータが含まれない
- ✅ oec_doc.pdfに関する質問で「該当する文書が見つかりません」となる

---

### **TC-S03: 異常系 - インデックス分離確認**

| 項目 | 内容 |
|------|------|
| **目的** | 各ユーザーのデータが適切なインデックスに分離されることを確認 |
| **前提条件** | - Azure Searchに直接アクセス可能 |

#### **テスト手順**
1. **データ投入** → 各ユーザーで専用文書をアップロード
   - admin → admin_doc.pdf
   - oec → oec_doc.pdf  
   - haga → haga_doc.pdf
   - nakajima → nakajima_doc.pdf
2. **Azure Search確認** → 各インデックスの内容を直接確認

#### **期待結果**
- ✅ adminインデックスにはadmin_doc.pdfのみ存在
- ✅ oecインデックスにはoec_doc.pdfのみ存在
- ✅ hagaインデックスにはhaga_doc.pdfのみ存在
- ✅ nakajimaインデックスにはnakajima_doc.pdfのみ存在
- ❌ 他ユーザーのデータが混入していない

---

### **TC-S04: 異常系 - 権限昇格攻撃**

| 項目 | 内容 |
|------|------|
| **目的** | 権限昇格攻撃が防御されることを確認 |
| **前提条件** | - 各ユーザーのデータが存在 |

#### **テスト手順**
1. **ログイン** → hagaユーザーでログイン
2. **不正アクセス試行** → 以下のパターンを試行
   - URLパラメータ操作: `?username=admin`
   - POST Body操作: `{"username": "admin"}`
   - Cookie操作: セッションCookieの改ざん
3. **表示確認** → 文書一覧の内容を確認
4. **チャット確認** → 管理者データに関する質問を実行

#### **期待結果**
- ✅ 全ての不正アクセス試行が失敗する
- ✅ hagaユーザーのデータのみが表示される
- ✅ 管理者データに関する質問で適切にアクセス拒否される

---

### **TC-S05: 異常系 - セッション乗っ取り**

| 項目 | 内容 |
|------|------|
| **目的** | セッション管理の安全性を確認 |
| **前提条件** | - 2つのブラウザ/タブが使用可能 |

#### **テスト手順**
1. **ブラウザA** → oecユーザーでログイン
2. **ブラウザB** → hagaユーザーでログイン
3. **セッション確認** → 各ブラウザで文書一覧を確認
4. **同時操作** → 両ブラウザで同時にファイルアップロード
5. **混在確認** → 各ユーザーの文書が適切に分離されているか確認

#### **期待結果**
- ✅ 各ブラウザで正しいユーザーのデータのみ表示される
- ✅ 同時アップロードでもデータが混在しない
- ✅ セッションが独立して管理される

---

## 🔍 **CRUD操作別テストマトリックス**

### **Create (作成)**
| ユーザー | 対象インデックス | 期待結果 | 確認方法 |
|----------|------------------|----------|----------|
| admin | adminインデックス | ✅ 成功 | Azure Search確認 |
| oec | oecインデックス | ✅ 成功 | Azure Search確認 |
| haga | hagaインデックス | ✅ 成功 | Azure Search確認 |
| haga | adminインデックス | ❌ 失敗 | エラーメッセージ確認 |
| oec | hagaインデックス | ❌ 失敗 | エラーメッセージ確認 |

### **Read (読み取り)**
| ユーザー | 対象データ | 期待結果 | 確認方法 |
|----------|------------|----------|----------|
| admin | admin文書 | ✅ 表示 | 文書一覧/検索 |
| oec | oec文書 | ✅ 表示 | 文書一覧/検索 |
| haga | haga文書 | ✅ 表示 | 文書一覧/検索 |
| haga | admin文書 | ❌ 非表示 | 文書一覧/検索 |
| oec | haga文書 | ❌ 非表示 | 文書一覧/検索 |

### **Update (更新)**
| ユーザー | 対象データ | 期待結果 | 確認方法 |
|----------|------------|----------|----------|
| admin | admin文書 | ✅ 成功 | 再アップロード |
| oec | oec文書 | ✅ 成功 | 再アップロード |
| haga | admin文書 | ❌ 失敗 | エラーメッセージ |

### **Delete (削除)**
| ユーザー | 対象データ | 期待結果 | 確認方法 |
|----------|------------|----------|----------|
| admin | admin文書 | ✅ 成功 | Azure Search確認 |
| oec | oec文書 | ✅ 成功 | Azure Search確認 |
| haga | admin文書 | ❌ 失敗 | エラーメッセージ |

---

## 🎯 **重点チェック項目**

### **1. データ混入防止**
- [ ] 各ユーザーのデータが専用インデックスにのみ登録される
- [ ] 他ユーザーのインデックスにデータが混入しない
- [ ] workIdがユーザー間で重複しても問題ない

### **2. 表示制御**
- [ ] 文書一覧に権限のないデータが表示されない
- [ ] 検索結果に権限のないデータが含まれない
- [ ] チャット回答で権限のないデータが参照されない

### **3. 権限チェック**
- [ ] 各CRUD操作で適切な権限チェックが実行される
- [ ] 権限エラー時に適切なメッセージが表示される
- [ ] ログに権限違反の記録が残される

### **4. セッション管理**
- [ ] ログイン状態が適切に管理される
- [ ] セッション乗っ取りが防止される
- [ ] ログアウト時にセッションが適切に破棄される

---

## 🚨 **異常系テスト**

### **T-E01: 存在しないユーザー**
- 無効なユーザー名でのログイン試行
- 期待: ログイン失敗

### **T-E02: 無効なworkId**
- 他ユーザーのworkIdでのアクセス試行
- 期待: アクセス拒否

### **T-E03: セッションタイムアウト**
- 長時間操作なしでのアクセス試行
- 期待: 再ログイン要求

### **T-E04: 同時ログイン**
- 同一ユーザーでの複数セッション
- 期待: 適切な制御

---

## 📊 **テスト実行記録**

### **テスト実行日**: ___________
### **テスト実行者**: ___________
### **環境**: ___________

| テストケース | 実行結果 | 備考 |
|--------------|----------|------|
| TC-S01 | ✅ / ❌ | |
| TC-S02 | ✅ / ❌ | |
| TC-S03 | ✅ / ❌ | |
| TC-S04 | ✅ / ❌ | |
| TC-S05 | ✅ / ❌ | |

### **総合判定**: ✅ 合格 / ❌ 不合格

---

## 🔧 **不具合発生時の対応**

### **1. データ混入が発生した場合**
- Azure Searchでデータの確認
- インデックス名の設定確認
- 権限チェック処理の見直し

### **2. 権限チェックが機能しない場合**
- AuthorizationServiceの処理確認
- 設定ファイルの確認
- ログの詳細分析

### **3. セッション管理に問題がある場合**
- Cookieの設定確認
- セッションタイムアウトの設定確認
- 認証処理の見直し

---

## 📝 **テスト完了基準**

1. **全テストケース合格**: TC-S01～TC-S05が全て合格
2. **CRUDマトリックス完了**: 全ての組み合わせで期待結果が得られる
3. **重点チェック項目完了**: 全ての項目で✅が付いている
4. **異常系テスト完了**: 全ての異常系テストで適切にエラーハンドリングされる

## 🏆 **成功基準**

- **セキュリティ**: 他ユーザーのデータに一切アクセスできない
- **安定性**: 全ての正常操作が確実に動作する
- **トレーサビリティ**: 全ての操作がログに記録される 